<!-- model_settings_modal.html -->
<div id="modelListModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>モデル設定</h2>
        <div class="provider-cards">
            <!-- OpenAI Card -->
            <div class="provider-card openai-card">
                <svg class="provider-logo" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#10a37f"/>
                    <path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16L3.95 6.06M14.31 16H2.83M16.62 12l-5.74 9.94" stroke="#ffffff" stroke-width="2" fill="none"/>
                </svg>
                <h3>OpenAI</h3>
                <button onclick="openProviderSetup('OpenAI')" class="setup-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    セットアップ
                </button>
            </div>
            
            <!-- Azure OpenAI Card -->
            <div class="provider-card azure-card">
                <svg class="provider-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="5" y="5" width="43" height="43" fill="#f25022"/>
                    <rect x="52" y="5" width="43" height="43" fill="#7fba00"/>
                    <rect x="5" y="52" width="43" height="43" fill="#00a4ef"/>
                    <rect x="52" y="52" width="43" height="43" fill="#ffb900"/>
                </svg>
                <h3>AzureOpenAI</h3>
                <button onclick="openProviderSetup('AzureOpenAI')" class="setup-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    セットアップ
                </button>
            </div>
            
            <!-- Claude Card -->
            <div class="provider-card claude-card">
                <svg class="provider-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="48" fill="#f5e8d6"/>
                    <g fill="#e69138">
                        <path d="M50 8 Q51 26 52 45 Q75 47 92 50 Q75 53 52 55 Q51 74 50 92 Q49 74 48 55 Q25 53 8 50 Q25 47 48 45 Q49 26 50 8 Z"/>
                        <path d="M50 8 Q51 26 52 45 Q75 47 92 50 Q75 53 52 55 Q51 74 50 92 Q49 74 48 55 Q25 53 8 50 Q25 47 48 45 Q49 26 50 8 Z" transform="rotate(22.5 50 50)"/>
                        <path d="M50 8 Q51 26 52 45 Q75 47 92 50 Q75 53 52 55 Q51 74 50 92 Q49 74 48 55 Q25 53 8 50 Q25 47 48 45 Q49 26 50 8 Z" transform="rotate(45 50 50)"/>
                    </g>
                </svg>
                <h3>Claude</h3>
                <button onclick="openProviderSetup('Claude')" class="setup-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    セットアップ
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modelSettingsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>モデル設定</h2>
        <form id="modelSettingsForm">
            <input type="hidden" id="modelType">
            <div class="form-group">
                <label for="modelName">モデル名</label>
                <input type="text" id="modelName" placeholder="モデル名">
            </div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <div class="input-with-icon">
                    <input type="password" id="apiKey" placeholder="API Key">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('apiKey')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group azure-field">
                <label for="apiVersion">API Version</label>
                <input type="text" id="apiVersion" placeholder="API Version">
            </div>
            <div class="form-group azure-field">
                <label for="endpoint">Endpoint</label>
                <input type="text" id="endpoint" placeholder="Endpoint">
            </div>
            <div class="button-container">
                <button type="submit">保存</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
    .provider-cards {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: nowrap;  /* この行を追加 */
        width: 100%;  /* この行を追加 */
        margin-top: 20px;
    }
    .provider-card {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 200px;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .provider-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .provider-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 15px;
    }
    .setup-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
        transition: background-color 0.3s ease;
        font-size: 14px;
    }
    .setup-btn:hover {
        background-color: #0056b3;
    }
    .setup-btn svg {
        margin-right: 8px;
        width: 16px;
        height: 16px;
    }
    .openai-card {
        background-color: #f0fff0;
    }
    .azure-card {
        background-color: #f0f8ff;
    }
    .claude-card {
        background-color: #f5e8d6;
    }
    #modelSettingsForm {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .form-group label {
        font-weight: bold;
        color: #333;
    }
    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
    }
    .input-with-icon {
        position: relative;
        display: flex;
        align-items: center;
    }
    .input-with-icon input {
        padding-right: 40px;
    }
    .toggle-password {
        position: absolute;
        right: 5px;
        background: none;
        border: none;
        cursor: pointer;
    }
    .eye-icon {
        width: 20px;
        height: 20px;
        color: #666;
    }
    .azure-field {
        display: none;
    }
    .button-container {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
    }
    #modelSettingsForm button[type="submit"] {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 16px;
    }
    #modelSettingsForm button[type="submit"]:hover {
        background-color: #0056b3;
    }
    #modelSettingsForm label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: white;
        background: linear-gradient(135deg, 
            #9254de 0%, 
            #7c3aed 50%, 
            #6025c0 100%);
        padding: 10px 15px;
        border-radius: 6px;
        box-shadow: 
            0 2px 4px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.1);
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        position: relative;
        transition: all 0.3s ease;
    }
    
    #modelSettingsForm label::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom right,
            rgba(255,255,255,0.1) 0%,
            rgba(255,255,255,0.05) 50%,
            rgba(255,255,255,0) 50.1%,
            rgba(0,0,0,0.05) 100%);
        pointer-events: none;
        border-radius: 6px;
    }
    
    #modelSettingsForm label:hover {
        box-shadow: 
        0 4px 8px rgba(0,0,0,0.15),
        inset 0 1px 0 rgba(255,255,255,0.2);
    transform: translateY(-1px);
    }
</style>

<script>
function openModelSettings() {
    document.getElementById("modelListModal").style.display = "block";
}

function openProviderSetup(modelType) {
    document.getElementById("modelType").value = modelType;
    document.getElementById("modelListModal").style.display = "none";
    document.getElementById("modelSettingsModal").style.display = "block";
    loadModelSettings(modelType);
}

function loadModelSettings(modelType) {
    axios.get(`/get_ai_model/?model_type=${modelType}`)
        .then(response => {
            const data = response.data;
            document.getElementById("modelName").value = data.name || '';
            document.getElementById("apiKey").value = data.api_key || '';
            document.getElementById("apiVersion").value = data.api_version || '';
            document.getElementById("endpoint").value = data.endpoint || '';
            toggleAzureFields(modelType);
        })
        .catch(error => {
            console.error('Error loading model settings:', error);
            document.getElementById("modelName").value = '';
            document.getElementById("apiKey").value = '';
            document.getElementById("apiVersion").value = '';
            document.getElementById("endpoint").value = '';
            toggleAzureFields(modelType);
        });
}

function toggleAzureFields(modelType) {
    const azureFields = document.querySelectorAll('.azure-field');
    
    if (modelType === "AzureOpenAI") {
        azureFields.forEach(field => field.style.display = "block");
    } else {
        azureFields.forEach(field => field.style.display = "none");
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const eyeIcon = input.nextElementSibling.querySelector('.eye-icon');
    
    if (input.type === "password") {
        input.type = "text";
        eyeIcon.innerHTML = `
            <line x1="3" y1="3" x2="21" y2="21"></line>
            <path d="M10.584 10.587a2 2 0 0 0 2.828 2.83"></path>
            <path d="M21 12c-2.08 1.822-4.342 3-7 3a8.93 8.93 0 0 1-5.772-2.084"></path>
            <path d="M9.148 9.145a8.98 8.98 0 0 0-4.876 2.855"></path>
            <path d="M3 12s4-8 11-8c2.186 0 4.17.712 5.783 1.89"></path>
        `;
    } else {
        input.type = "password";
        eyeIcon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

document.getElementById("modelSettingsForm").onsubmit = function(e) {
    e.preventDefault();
    const modelType = document.getElementById("modelType").value;
    const modelName = document.getElementById("modelName").value;
    const apiKey = document.getElementById("apiKey").value;
    const apiVersion = document.getElementById("apiVersion").value;
    const endpoint = document.getElementById("endpoint").value;

    const data = {
        model_type: modelType,
        name: modelName,
        api_key: apiKey,
        api_version: apiVersion,
        endpoint: endpoint
    };

    axios.post('/save_or_update_model/', data)
    .then(response => {
        if (response.data.status === 'success') {
            alert('モデルが保存されました');
            document.getElementById("modelSettingsModal").style.display = "none";
            document.getElementById("modelListModal").style.display = "block";
        } else {
            throw new Error('保存に失敗しました');
        }
    })
    .catch(error => {
        console.error('Error saving model:', error);
        alert('モデルの保存中にエラーが発生しました');
    });
};

// モーダルを閉じる処理
document.querySelectorAll(".modal .close").forEach(closeBtn => {
    closeBtn.onclick = function() {
        const modal = this.closest('.modal');
        if (modal.id === "modelSettingsModal") {
            modal.style.display = "none";
            document.getElementById("modelListModal").style.display = "block";
        } else {
            modal.style.display = "none";
        }
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        if (event.target.id === "modelSettingsModal") {
            event.target.style.display = "none";
            document.getElementById("modelListModal").style.display = "block";
        } else {
            event.target.style.display = "none";
        }
    }
}
// 初期化時にモデル設定をロード
document.addEventListener('DOMContentLoaded', function() {
    const modelListModal = document.getElementById("modelListModal");
    const modelSettingsModal = document.getElementById("modelSettingsModal");
    
    modelListModal.style.display = "none";
    modelSettingsModal.style.display = "none";
});
</script>